package org.smartautomation.user.smartclassroom.Prof;import android.annotation.TargetApi;import android.app.AlertDialog;import android.app.Fragment;import android.content.DialogInterface;import android.content.Intent;import android.os.AsyncTask;import android.os.Build;import android.os.Bundle;import org.smartautomation.user.smartclassroom.Global.Properties;import android.os.Handler;import android.support.annotation.Nullable;import android.support.annotation.RequiresApi;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.ArrayAdapter;import android.widget.Button;import android.widget.CompoundButton;import android.widget.Spinner;import android.widget.Switch;import android.widget.Toast;import org.smartautomation.user.smartclassroom.R;import org.apache.http.HttpResponse;import org.apache.http.NameValuePair;import org.apache.http.client.HttpClient;import org.apache.http.client.entity.UrlEncodedFormEntity;import org.apache.http.client.methods.HttpGet;import org.apache.http.client.methods.HttpPost;import org.apache.http.impl.client.DefaultHttpClient;import org.apache.http.message.BasicNameValuePair;import org.smartautomation.user.smartclassroom.Schedule_Guard.Schedule_Guard;import java.io.InputStream;import java.util.ArrayList;import java.util.Calendar;import java.util.List;import java.util.Timer;import java.util.TimerTask;/** * Created by kenonnegammad on 20/01/2018. */public class Controller extends Fragment{    View myView;    Properties p=new Properties();    Switch light_switch,socket_switch,front_switch,back_switch,all_switch;    String light,socket,front,back,all;    String condition;    TimerTask timerTask;    String stud_id;    Spinner mySpinner;    Button btn_rooms;    String room="R206";    Timer timer;     Handler handler = new Handler();    //Properties p=new Properties();    @TargetApi(Build.VERSION_CODES.JELLY_BEAN)    @RequiresApi(api = Build.VERSION_CODES.JELLY_BEAN)    @Nullable    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {        myView = inflater.inflate(R.layout.controller_dash, container, false);        light_switch = (Switch) myView.findViewById(R.id.light_switch);        socket_switch = (Switch) myView.findViewById(R.id.socket_switch);        front_switch = (Switch) myView.findViewById(R.id.front_switch);        back_switch = (Switch) myView.findViewById(R.id.back_switch);       // btn_rooms = (Button) myView.findViewById(R.id.btn_controller_room);        stud_id = getArguments().getString("Stud_id");//        btn_rooms.setOnClickListener(this);        Update_Device_Status();        light_switch.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {            @Override            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {                if (isChecked) {                    condition = "control";                    light = "ON";                } else {                    condition = "control";                    light = "OFF";                }                if (room.length() > 0) {                    timer.cancel();                    new ControllerTask().execute();                } else {                    MessageBox("Please Select Room");                }            }        });        socket_switch.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {            @Override            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {                if (isChecked){                    condition = "control";                    socket = "ON";                }else{                    condition = "control";                    socket = "OFF";                }                if (room.length() > 0) {                    timer.cancel();                    new ControllerTask().execute();                } else {                    MessageBox("Please Select Room");                }            }        });        front_switch.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {            @Override            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {                if(isChecked){                    condition = "control";                    front = "ON";                }else{                    condition = "control";                    front = "OFF";                }                if (room.length() > 0) {                    timer.cancel();                    new ControllerTask().execute();                } else {                    MessageBox("Please Select Room");                }            }        });        back_switch.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {            @Override            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {                if (isChecked){                    condition = "control";                    back = "ON";                }else{                    condition = "control";                    back = "OFF";                }                if (room.length() > 0) {                    timer.cancel();                    new ControllerTask().execute();                } else {                    MessageBox("Please Select Room");                }            }        });        return myView;    }    public void Update_Device_Status(){        timer = new Timer();        timerTask=new TimerTask() {            @Override            public void run() {                getActivity().runOnUiThread(new Runnable() {                    @Override                    public void run() {                         new Load_Device_Status().execute();                    }                });            }        };        timer.schedule(timerTask,0,3000);    }    public void MessageBox(String message){        Toast.makeText(getActivity(),message,Toast.LENGTH_SHORT).show();    }//    @Override//    public void onClick(View v) {//        final Handler handler=new Handler();//        AlertDialog.Builder mBuilder= new AlertDialog.Builder(getActivity(),R.style.MyDialogTheme);//        View view1 = getActivity().getLayoutInflater().inflate(R.layout.spinner,null);//        mBuilder.setTitle("Pick Room");//        mySpinner = (Spinner) view1.findViewById(R.id.spinner_design);//        ArrayAdapter<String> adapter=new ArrayAdapter<String>(getActivity(),android.R.layout.simple_spinner_item,getResources().getStringArray(R.array.rooms));//        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);//        mySpinner.setAdapter(adapter);//        mBuilder.setPositiveButton("Ok", new DialogInterface.OnClickListener() {//            @Override//            public void onClick(DialogInterface dialogInterface, int i) {//                room = mySpinner.getSelectedItem().toString();//                handler.post(new Runnable() {//                    @Override//                    public void run() {//                        Update_Device_Status();//                    }//                });//                btn_rooms.setText("Selected room:" + " " + mySpinner.getSelectedItem().toString());//            }//        });//        mBuilder.setNegativeButton("Cancel", new DialogInterface.OnClickListener() {//            @Override//            public void onClick(DialogInterface dialogInterface, int i) {//                dialogInterface.dismiss();//            }//        });//        mBuilder.setView(view1);//        AlertDialog dialog= mBuilder.create();//        dialog.show();//    }    public class ControllerTask extends AsyncTask<String,Void,String>{        @Override        protected void onPreExecute() {            super.onPreExecute();        }        @Override        protected String doInBackground(String... strings) {            String output = "";            byte[] data;            HttpPost httppost;            HttpClient httpclient;            StringBuffer buffer = null;            HttpResponse response;            InputStream inputStream;            HttpGet httpGet;            Intent intent;            String resultString="";            Bundle extras=new Bundle();            List<NameValuePair> nameValuePairs;            nameValuePairs = new ArrayList<NameValuePair>(2);            // nameValuePairs.add(new BasicNameValuePair("id",stud_id));            nameValuePairs.add(new BasicNameValuePair("condition",condition));            nameValuePairs.add(new BasicNameValuePair("id",stud_id));            nameValuePairs.add(new BasicNameValuePair("frontlock",front));            nameValuePairs.add(new BasicNameValuePair("light",light));            nameValuePairs.add(new BasicNameValuePair("outlet",socket));            nameValuePairs.add(new BasicNameValuePair("backlock",back));            nameValuePairs.add(new BasicNameValuePair("room",room));            try {                String Url = p.getIP()+"controlDevice.php";                httpclient = new DefaultHttpClient();                httppost = new HttpPost(Url);                httppost.setEntity(new UrlEncodedFormEntity(nameValuePairs));                response = httpclient.execute(httppost);                inputStream = response.getEntity().getContent();                data = new byte[256];                buffer = new StringBuffer();                int len = 0;                while (-1 != (len = inputStream.read(data)) ) {                    buffer.append(new String(data, 0, len));                }                //for the output or echo                String bufferedInputString = buffer.toString();                inputStream.close();            }            catch (final Exception e) {                getActivity().runOnUiThread(new Runnable() {                    public void run() {                        Toast.makeText(getActivity(), "error: "+e.toString(), Toast.LENGTH_SHORT).show();                    }                });            }            return buffer.toString();        }        @Override        protected void onPostExecute(String s) {            super.onPostExecute(s);            System.out.println(s);            Update_Device_Status();        }    }    public class Load_Device_Status extends AsyncTask<Void,Void,String>{        @Override        protected void onPreExecute() {            super.onPreExecute();        }        @Override        protected String doInBackground(Void... voids) {            String output = "";            byte[] data;            HttpPost httppost;            HttpClient httpclient;            StringBuffer buffer = null;            HttpResponse response;            InputStream inputStream;            HttpGet httpGet;            Intent intent;            String resultString="";            Bundle extras=new Bundle();            List<NameValuePair> nameValuePairs;            nameValuePairs = new ArrayList<NameValuePair>(2);            nameValuePairs.add(new BasicNameValuePair("condition","None"));            nameValuePairs.add(new BasicNameValuePair("room",room));            try {                //ip= new Properties();                String Url = p.getIP()+"controlDevice.php";                httpclient = new DefaultHttpClient();                httppost = new HttpPost(Url);                httppost.setEntity(new UrlEncodedFormEntity(nameValuePairs));                response = httpclient.execute(httppost);                inputStream = response.getEntity().getContent();                data = new byte[256];                buffer = new StringBuffer();                int len = 0;                while (-1 != (len = inputStream.read(data)) ) {                    buffer.append(new String(data, 0, len));                }                //for the output or echo                String bufferedInputString = buffer.toString();                inputStream.close();            }            catch (final Exception e) {                getActivity().runOnUiThread(new Runnable() {                    public void run() {                        Toast.makeText(getActivity(), "error: "+e.toString(), Toast.LENGTH_SHORT).show();                    }                });            }            return buffer.toString();        }        @Override        protected void onPostExecute(String s) {            super.onPostExecute(s);            String[] splitted = null;            System.out.println(s);            if (room.length() > 0) {                splitted = s.split(":");                light = splitted[2];                socket = splitted[3];                front = splitted[4];                back = splitted[5];                if (light.equals("ON")) {                    light_switch.setChecked(true);                }                if (socket.equals("ON")) {                    socket_switch.setChecked(true);                }                if (front.equals("ON")) {                    front_switch.setChecked(true);                }                if (back.equals("ON")) {                    back_switch.setChecked(true);                }                if (light.equals("OFF")) {                    light_switch.setChecked(false);                }                if (socket.equals("OFF")) {                    socket_switch.setChecked(false);                }                if (front.equals("OFF")) {                    front_switch.setChecked(false);                }                if (back.equals("OFF")) {                    back_switch.setChecked(false);                }            }            else { MessageBox("Please Select Room"); }        }    }}